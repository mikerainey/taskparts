# binaries go here
TASKPARTS_INSTALL_PATH?=bin

TASKPARTS_PLATFORM_FLAGS?=-DTASKPARTS_POSIX=1 -DTASKPARTS_X64=1
#TASKPARTS_PLATFORM_FLAGS?=-DTASKPARTS_DARWIN=1 -DTASKPARTS_ARM64=1 
TASKPARTS_OPTIONAL_FLAGS?=
TASKPARTS_CPP_FLAGS?=-std=c++17 -fno-stack-protector -fno-asynchronous-unwind-tables
TASKPARTS_FLAGS=$(TASKPARTS_CPP_FLAGS) $(TASKPARTS_PLATFORM_FLAGS) $(TASKPARTS_OPTIONAL_FLAGS)
TASKPARTS_OPT_FLAGS=-O3 -DNDEBUG -march=native
TASKPARTS_STA=-DTASKPARTS_STATS=1
TASKPARTS_LOG=-DTASKPARTS_LOGGING=1
TASKPARTS_STA_FLAGS=$(TASKPARTS_STA) $(TASKPARTS_OPT_FLAGS)
TASKPARTS_LOG_FLAGS=$(TASKPARTS_LOG) $(TASKPARTS_STA) $(TASKPARTS_OPT_FLAGS)
TASKPARTS_DBG_FLAGS=$(TASKPARTS_STA) $(TASKPARTS_LOG) $(VALGRIND_CFLAG) -O -g3
TASKPARTS_MSDBG=-DTASKPARTS_META_SCHEDULER_SERIAL_RANDOM=1
TASKPARTS_MSDBG_FLAGS=$(TASKPARTS_MSDBG) $(TASKPARTS_DBG_FLAGS)
TASKPARTS_LINKER_FLAGS?=

TASKPARTS_FILES=taskparts.cpp

%.sta: %.cpp install_folder
	$(CXX) $(TASKPARTS_FLAGS) $(TASKPARTS_STA_FLAGS) $< -o $(TASKPARTS_INSTALL_PATH)/$@ $(TASKPARTS_LINKER_FLAGS)
%.log: %.cpp install_folder
	$(CXX) $(TASKPARTS_FLAGS) $(TASKPARTS_LOG_FLAGS) $< -o $(TASKPARTS_INSTALL_PATH)/$@ $(TASKPARTS_LINKER_FLAGS)
%.dbg: %.cpp install_folder
	$(CXX) $(TASKPARTS_FLAGS) $(TASKPARTS_DBG_FLAGS) $< -o $(TASKPARTS_INSTALL_PATH)/$@ $(TASKPARTS_LINKER_FLAGS)
%.msdbg: %.cpp install_folder
	$(CXX) $(TASKPARTS_FLAGS) $(TASKPARTS_MSDBG_FLAGS) $< -o $(TASKPARTS_INSTALL_PATH)/$@ $(TASKPARTS_LINKER_FLAGS)

.PHONY: install_folder
install_folder:
	mkdir -p $(TASKPARTS_INSTALL_PATH)

clean:
	rm -rf bin
